# Dev Graph Audit Directory - Agent Guidelines

## Overview
This directory contains audit reports, analysis documents, and ingestion run results for the Developer Graph system. It serves as the primary location for data quality tracking, performance monitoring, and historical comparison.

## Purpose
1. **Data Quality Monitoring**: Track relationship counts, orphan nodes, and data integrity metrics
2. **Performance Benchmarking**: Compare ingestion durations and throughput across runs
3. **Regression Detection**: Identify when counts or quality metrics degrade
4. **Historical Analysis**: Maintain audit trail for troubleshooting and optimization

---

## File Types

### Audit Files (`audit-YYYYMMDD-HHMMSS.json`)
**Generated by:** `POST /api/v1/dev-graph/audit`  
**Frequency:** After each ingestion or on-demand  
**Retention:** Keep last 10 audits for comparison

**Contents:**
- Node counts by type
- Relationship counts by type
- Orphan node analysis
- Data quality checks
- Library coverage summary
- File decoding statistics

**Example:**
```json
{
  "node_counts": [{"type": "Symbol", "count": 13892}, ...],
  "relationship_counts": [{"type": "MENTIONS_SYMBOL", "count": 83710}, ...],
  "orphans": [{"type": "File", "count": 3}, ...],
  "checks": {
    "requirements_without_part_of": 51,
    "documents_without_chunks": 1,
    "chunks_without_links": 0,
    ...
  }
}
```

---

### Ingestion Reports (`*_run*.json`)
**Generated by:** `POST /api/v1/dev-graph/ingest/unified`  
**Frequency:** After each successful ingestion  
**Retention:** Keep last 5 runs plus notable benchmarks

**Contents:**
- success: boolean
- total_duration: seconds
- stages_completed: count
- final_statistics: comprehensive metrics
- performance_metrics: throughput rates
- job_id: unique identifier

**Key Metrics:**
- `total_nodes`: Overall node count
- `total_relationships`: Overall relationship count
- `quality_score`: 0-100 scale
- `orphaned_nodes`: Count of disconnected nodes
- `node_breakdown`: Per-type counts
- `relationship_breakdown`: Per-type counts

---

### Analysis Documents (`*.md`)
**Generated by:** Manual analysis or agent investigation  
**Frequency:** After major changes or when issues detected  
**Retention:** Permanent for historical reference

**Key Documents:**

#### `COMPREHENSIVE_AUDIT_ANALYSIS.md` (2025-09-30)
Comprehensive analysis of the ingestion pipeline including:
- Node and relationship reconciliation (log vs DB)
- Critical discrepancies identified (MENTIONS_LIBRARY loss, etc.)
- Data quality issues breakdown (requirements without PART_OF, etc.)
- Performance bottleneck analysis
- Recommendations prioritized by severity

#### `FEATURE_REQUEST_DEV_GRAPH_LINK_INTEGRITY.md`
Historical feature request documenting:
- Library coverage underrepresentation issues
- Document/library relationship gaps
- Import parsing limitations
- Chunk linking improvements needed

---

## Audit Analysis Workflow

### After Each Ingestion
1. Generate audit: `POST /api/v1/dev-graph/audit`
2. Save to timestamped file
3. Compare key metrics with previous audit:
   - Node count delta
   - Relationship count delta
   - Quality score change
   - New orphan nodes
4. Document any regressions in markdown

### When Issues Detected
1. Create detailed analysis document (like `COMPREHENSIVE_AUDIT_ANALYSIS.md`)
2. Cross-reference logs with database state
3. Identify root causes
4. Propose fixes with priority
5. Track fix implementation
6. Re-run audit to verify improvements

### Quarterly Review
1. Analyze trend across all audits
2. Identify persistent data quality issues
3. Update performance benchmarks
4. Archive old audits (keep only key milestones)

---

## Key Metrics & Thresholds

### Node Counts
| Metric | Current | Acceptable Range | Alert If |
|--------|---------|------------------|----------|
| Total Nodes | 30,822 | 25,000 - 35,000 | < 20,000 or > 40,000 |
| Symbol Nodes | 13,892 | 12,000 - 15,000 | < 10,000 |
| Chunk Nodes | 13,829 | 12,000 - 15,000 | < 10,000 |
| Library Nodes | 97 | 90 - 110 | < 80 |

### Relationship Counts
| Metric | Current | Acceptable Range | Alert If |
|--------|---------|------------------|----------|
| Total Relationships | 255,389 | 240,000 - 270,000 | < 200,000 |
| MENTIONS_SYMBOL | 83,710 | 70,000 - 90,000 | < 60,000 |
| RELATES_TO | 84,503 | 75,000 - 90,000 | < 65,000 |
| CO_OCCURS_WITH | 20,175 | 18,000 - 22,000 | < 15,000 |

### Data Quality
| Metric | Current | Target | Alert If |
|--------|---------|--------|----------|
| Quality Score | 100.0% | ≥ 99.5% | < 99.0% |
| Orphaned Nodes | 7 | < 10 | > 20 |
| chunks_without_links | 0 | 0 | > 0 |
| requirements_without_part_of | 51 | < 10 | > 60 |

---

## Common Issues & Patterns

### Issue: requirements_without_part_of > 60
**Cause:** Commit-message requirements don't follow FR-XX-XXX pattern  
**Detection:** Check `audit.checks.requirements_without_part_of`  
**Fix:** Update `unified_ingest.py::_normalize_chunk_relationships()`  
**Status:** Reduced from 64 to 51 (ongoing improvement)

### Issue: MENTIONS_LIBRARY count drops significantly
**Cause:** Library mention detection logic changes or deduplication  
**Detection:** Compare relationship_breakdown between audits  
**Investigation:** Check Stage 8 logs for `library_doc_mentions` count  
**Note:** Some discrepancy expected due to MERGE deduplication

### Issue: Relationship counts inconsistent between runs
**Cause:** Non-deterministic symbol extraction or co-occurrence calculation  
**Detection:** ±5% variance in major relationship types  
**Investigation:** Review Stage 8 logs for symbol extraction errors  
**Fix:** Ensure deterministic ordering and stable hashing

### Issue: Orphan nodes increasing
**Cause:** Relationship creation failures or incomplete linking  
**Detection:** `audit.orphans` array has entries  
**Investigation:** Identify orphan types and check linking logic  
**Fix:** Add normalization step to link orphans

---

## Comparison Methodology

### Node Count Changes
```
delta = new_audit.node_counts[type] - previous_audit.node_counts[type]
percent_change = (delta / previous_audit.node_counts[type]) * 100

Alert if:
- percent_change > 20% (major increase)
- percent_change < -10% (decrease)
```

### Relationship Count Changes
```
delta = new_audit.relationship_counts[type] - previous_audit.relationship_counts[type]
percent_change = (delta / previous_audit.relationship_counts[type]) * 100

Alert if:
- percent_change > 25% (major increase)
- percent_change < -15% (significant decrease)
```

### Quality Score Degradation
```
delta = new_audit.quality_score - previous_audit.quality_score

Alert if:
- delta < -0.5 (quality degradation)
- chunks_without_links increases
- orphaned_nodes increases
```

---

## Historical Milestones

### 2025-09-30: Requirement Linking Improvement
- **Before:** 64 requirements without PART_OF
- **After:** 51 requirements without PART_OF  
- **Change:** +13 requirements linked (-20%)
- **Method:** Document-based linking via chunks

### 2025-09-30: Sprint Datetime Fix
- **Issue:** Sprint-commit linking failed with datetime parsing error
- **Cause:** Duplicate time appending to ISO8601 dates
- **Fix:** Removed `+ 'T00:00:00'` concatenation
- **Result:** All 12 sprints now properly linked to commits

### 2025-09-30: Audit Query Fix
- **Issue:** Neo4j property access errors in audit queries
- **Cause:** Bracket notation `decoding['encoding']` not supported
- **Fix:** Changed to dot notation `decoding.encoding`
- **Result:** Audit endpoint works without warnings

### 2025-09-24: Stage 8 Success (Historical)
- **Nodes:** 30,295 (74% increase from previous)
- **Relationships:** 155,696 (582% increase from previous)
- **Symbol Extraction:** 14,877 symbols
- **Milestone:** First successful enhanced connectivity run

---

## Automation Opportunities

### Automated Alerting
```python
# Pseudocode for alert system
if audit.quality_score < 99.0:
    alert("Quality score below threshold")

if audit.checks.chunks_without_links > 0:
    alert("Chunk linking integrity compromised")

if audit.orphans.total > 20:
    alert("Excessive orphan nodes detected")
```

### Trend Analysis
```python
# Track metrics over time
metrics = load_last_n_audits(10)
trends = calculate_moving_averages(metrics)

if current < (trend.mean - 2 * trend.std):
    alert("Metric significantly below trend")
```

### Regression Detection
```python
# Compare with previous successful run
if current.total_relationships < previous.total_relationships * 0.9:
    alert("Major relationship loss detected")
    trigger_investigation()
```

---

## Development Guidelines

### Adding New Metrics
1. Update `_compute_audit()` in `developer_graph/routes/ingest.py`
2. Add to `checks` dictionary or create new section
3. Document in this AGENTS.md
4. Update thresholds table above
5. Add to comparison methodology

### Archiving Strategy
- Keep last 10 audits unconditionally
- Keep monthly milestone audits permanently
- Keep audits before/after major changes
- Compress audits older than 3 months

### File Naming Conventions
- Audits: `audit-YYYYMMDD-HHMMSS.json`
- Reports: `{descriptor}_run_{timestamp}.json`
- Analysis: `{topic}_ANALYSIS.md` or `FEATURE_REQUEST_{topic}.md`
- Use uppercase for markdown filenames
- Use snake_case for JSON filenames

---

## Related Documentation
- `../developer_graph/routes/AGENTS.md`: Ingestion pipeline details
- `../developer_graph/AGENTS.md`: Developer graph module overview
- `COMPREHENSIVE_AUDIT_ANALYSIS.md`: Detailed audit breakdown
- `FEATURE_REQUEST_DEV_GRAPH_LINK_INTEGRITY.md`: Historical feature request
